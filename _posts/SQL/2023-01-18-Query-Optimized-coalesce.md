# 쿼리 최적화 - COALESCE vs or
> 판매 내역 리스트를 불러오는 쿼리를 동료 개발자가 짰지만 효율적이지 않고 속도도 좋지않아서 최적화를 진행했다.

기존 로직 순서
1. 이메일 검색 로직을 위해 유저들의 이메일을 가저온다.
2. 만약 이메일이 비어있다면 모든 유저들의 정보를 가져와 판매 내역에 판매자인지 검사한다. - 여기까지 1s 114ms
3. 추가적인 검색할 조건이 있다면 `COALESCE(IF(:code = '', null, :code), code)` 이런식으로 검색 16ms

여기서 의문점은 왜 서브 쿼리를 사용해서 필요한 유저의 이메일만 검색하지 않았는지, 왜 이렇게 IF를 사용해서 해야 했는지가 궁금했었다.
내 생각으론 `(:code is null or :code = '' or mg.code = :code)` 이런 식으로 짜면 굳이 함수를 쓰거나 어려운 로직을 사용하지 않아도 될거 같다는 생각이 들어서 로직을 수정했더니 1초가 넘어가는 로직을 30ms정도로 줄였다.

```
COALESCE(COL1, COL2, ..... COLn)

NVL과 같이 인자 중에서 NULL이 아닌 첫 번째 값을 리턴한다. NVL과 다른점은 2개의 인자값만 줄수 있었던 NVL과 다르게 COALESCE은 NULL을 체크하고자 하는 모든 값을 넣을 수 있다. 로직은 COL1이 NULL일 경우 COL2를 검사하고 COL2가 NULL일 경우 다음 인자를 쭈우욱 한다음 마지막 인자 값까지 검사후 NULL이 아닌 값을 반환 만약 모든 인자가 NULL일 경우 NULL을 반환
```